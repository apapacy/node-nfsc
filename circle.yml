---
general:
  artifacts:
    - /artifacts/
machine:
  node:
    version: 4.5.0
  environment:
    CXX: g++-4.9
    ENABLE_LOCAL_CACHE: true

dependencies:
  pre:
    - sudo apt-get update -y
    - sudo apt-get install -y krb5-multidev
    - npm install nan
    - npm install node-gyp

database:
  pre:
    - sudo apt-get install -y rpcbind
    - git clone git@github.com:nfs-ganesha/nfs-ganesha.git -b V2.4.3
    - ( cd nfs-ganesha && git submodule update --init )
    - mkdir nfs-ganesha/build
    - ( cd nfs-ganesha/build && cmake  ../src )
    - make -C nfs-ganesha/build -j 5
    - sudo make -C nfs-ganesha/build install
    - sudo mkdir -p /artifacts /nfs /var/lib/nfs/ganesha/v4old/node0
    - sudo sed -i s,/nonexistant,/nfs,g /etc/ganesha/ganesha.conf
  override:
    - sudo ganesha.nfsd -L /artifacts/ganesha.log
  post:
    - while ! grep 'NFS Server Now NOT IN GRACE' /artifacts/ganesha.log ; do echo "waiting for grace period to end" ; sleep 1 ; done

test:
  pre:
    - cp tests/config.json.ci tests/config.json
  override:
    - npm test
